# 群晖笔记

## 笔记

群晖的 Synology Drive 不支持 windows 的软连接。

```sh
# 更新 uv、pycode 项目
uu

# 每日定时任务
daily
```

## 定时任务

* 每天 `00:00` 清理回收站，保留 30 天。
* 每天 `01:30` 自动关机
* 每天 `07:30` 自动开机
* 每天 `21:00` 执行 `daily.py` 。命令：`~/.local/bin/uv run --project ~/pycode ~/pycode/cron/daily.py`

## 设置

### 安全设置

遵循最小化原则，非必要不开通，非必要不暴露

* 最小化权限：所有普通用户仅开放 SMB、Photos 权限。
* 最小化端口服务：使用路由器的虚拟服务器功能，仅开放特定的端口至外网访问；不使用 DMZ 功能。
* 修改默认端口号：由于 NAS 暴露至公网，所有能访问的服务都必须修改端口号。
* 所有服务必须设置强密码，比如 Syncthing。
* 启用自动封锁：5 分钟内登录失败次数超过 5 次，自动封锁登陆者的 IP。
* 启用 DoS 保护。
* 不使用 user、guest、mysql、root、admin、system、git、debian 等常见的用户名。

### 常用配置

```sh
# 环境变量写到 ~/.profile 文件内比较合适
# bash alias 可以写到 ~/.bash_aliases 里面。
# 群晖默认家目录里是空的，所以其实写到 .profile、.bashrc 都行
# 这里为了简单，把 bash alias 也写到 .profile 文件里
cat << "EOF" | tee ~/.profile
if [ -d "$HOME/.local/bin" ] ; then
    PATH="$HOME/.local/bin:$PATH"
fi

alias ll='ls -alF'
alias la='ls -A'
alias rs='sudo systemctl restart syncthing@${USER}.service'
alias daily='~/.local/bin/uv run --project ~/pycode ~/pycode/cron/daily.py'
alias uu='bash ~/pycode/cron/uu.sh'
EOF
# 加载并查看
. ~/.profile
cat ~/.profile
```

### 路由器端口转发

Tp-link 路由器的端口转发功能叫做：虚拟服务器，这样可以不用将整个服务器暴露至公网中，仅暴露指定的端口。

|   服务    | 端口  | 备注 |
| :-------: | :---: | :--: |
|   HTTPS   | 20001 |      |
|    SSH    | 20002 |      |
|  路由器   | 20003 |      |
| Syncthing | 20004 |      |
|  WebDAV   | 20005 |      |

### 配置 SSH

控制面板 - 终端机和 SNMP，开启 SSH。

如果要使用照片视频备份 App，需要开启 rsync 服务，SSH 安全等级设置为中。

### SSH 免密登录

参考：<https://blog.csdn.net/leirace/article/details/104547270>

1、创建密钥、公钥。

2、上传公钥

```sh
# 注意：群晖用户目录权限默认为 777，必须要修改为 755 才能免密登录。
chmod 755 $HOME

# 推荐使用此方法，自动配置权限等
ssh-copy-id -p 20002 username@hostname
```

3、修改 sshd 配置文件

```sh
sudo vi /etc/ssh/sshd_config
# 检查如下三个设置
RSAAuthentication yes
PubkeyAuthentication yes
AuthorizedKeysFile .ssh/authorized_keys
```

4、重启 sshd（实际发现要去群晖管理页面控制面板中 关闭 - 启用后才有效）

### 启用家目录

控制面板 - 用户账号 - 高级设置，启用家目录。

### sudo 免密

```sh
# sudo 命令免密
echo "$USER ALL=(ALL:ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/010-$USER
```

### 添加第三方源

参考：<https://synocommunity.com/>

套件中心 - 设置 - 套件来源，然后新增以下内容：

```sh
# 名称：SynoCommunity
# 地址：https://packages.synocommunity.com
```

然后就可以安装社区的套件了，比如：syncthing。

### 安装 python

群晖升级 DSM7.0 系统后，内置了 python3.8，套件中心官方有 python3.9 可供安装，SynoCommunity 社区有 python3.12 版本。

#### 最佳实践

参考：[pip 官方文档](https://pip.pypa.io/en/stable/installation/)

```sh
# 安装 pip
# wget -O - 'https://bootstrap.pypa.io/pip/3.8/get-pip.py' | python3 - --user
python3 -m ensurepip --upgrade --user

# 安装 UV，群晖系统太旧了，uv 官方脚本无法自动安装，只能使用 pip 安装了
# 以后升级 uv 也需要指定 python3.8
python3.8 -m pip install -U -i https://pypi.tuna.tsinghua.edu.cn/simple uv

# 安装最新版的 python，如果要设为系统默认 python，则添加--default 参数
# 以后使用 uv 管理下的虚拟环境运行所有脚本，就没必要设置为默认 python 了
uv python install


# 配置
python3.8 -m pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple
python3.8 -m pip config set global.extra-index-url "https://mirrors.ustc.edu.cn/pypi/simple"
python3.8 -m pip config set install.upgrade true
```

[不推荐] 如果将最新版的 python 设置为了系统默认 python，默认仍旧无法安装包

```sh
# 先提前配置下 pip

# 安装最新版的 pip，顺便将默认 pip 更新至新版 python 版本
python3 -m pip install -U pip --break-system-packages

# 重新登录 shell，然后测试 pip 版本
pip -V
```

#### 传统做法

修改用户默认 python 版本

```sh
# 群晖系统默认 python、python3 命令都指向 python3
# python2 才指向 python2。
>>> python -V
>>> python3 -V
>>> which python
/bin/python

>>> which python3
/bin/python3

>>> which python3.8
/usr/local/bin/python3.8
```

安装最新版 python，执行如下操作：

```python
# 执行以下命令，修改默认 python3.12
rm ~/.local/bin/python
ln -s /usr/local/bin/python3.12 ~/.local/bin/python
rm ~/.local/bin/python3
ln -s /usr/local/bin/python3.12 ~/.local/bin/python3

# 退出 shell 然后重新登录，依次检查版本是否正确
python -V
python3 -V
pip -V
python -m pip -V

# 启用自定义库
python3 ~/pycode/src/set-pth.py
```

配置 python

```sh
# 社区版自带 pip，不需要手动安装 pip
# 系统版的需要手动安装 pip
# wget -O - 'https://bootstrap.pypa.io/get-pip.py' | python3 - --user
wget -O - 'https://bootstrap.pypa.io/pip/3.8/get-pip.py' | python3 - --user
# 安装 pip 后，pip 默认指向 python3.10 对应的 pip


# 这个设置没用
cat << "EOF" | tee ~/.bash_profile
# 控制历史命令记录的总行数
HISTSIZE=1000
# 清除整个命令历史中的重复条目
HISTCONTROL=erasedups
EOF
# 加载并查看
. ~/.bash_profile
cat ~/.bash_profile

```

#### 配置 pip

```sh
# 检查 python 版本
python3 -V
# 查看 pip 是否正确安装
pip -V
# 配置清华的 TUNA 软件源
pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple
# 配置科大的 UTSC 软件源
pip config set global.extra-index-url "https://mirrors.ustc.edu.cn/pypi/simple"
# 新版的 pip 检测到系统 site-package 目录不可写，会自动安装到 user 目录
# 配置：超时时间为 60 秒。
pip config set global.timeout 60
#默认为升级
pip config set install.upgrade true
# 设置默认安装至用户目录
pip config set install.user true

# 安装 python 库测试一下

pip install -U pip wheel setuptools
pip install requests
```

### 安装 syncthing

要同步的目录，需要将其所有权添加至 `sc-syncthing` 群组。

syncthing 的配置文件位于： `/volume1/@appstore/syncthing/var` 。

编辑配置文件：

```sh
sudo cat /volume1/@appdata/syncthing/config.xml
```

如果 syncthing 存在无法正常同步等异常情况，常规操作无法修复，可以考虑删除其缓存文件，执行以下命令删除其缓存文件：

```sh
# 删除 syncthing 缓存文件，删除需要重建数据库，根据机器的性能，时间可能会比较长，甚至 10 小时以上
sudo rm -rf /volume1/@appstore/syncthing/var/index-v0.14.0.db/
```

控制启动

```sh
sudo systemctl status pkgctl-syncthing.service
# 禁用开机启动
sudo systemctl disable pkgctl-syncthing.service

# 设置每天下午 16 点启动
cat << "EOF" | sudo tee /usr/lib/systemd/system/syncthing.timer
[Unit]
Description=Runs syncthing at 16:00 everyday

[Timer]
OnCalendar=16:00:00
Unit=pkgctl-syncthing.service

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl start syncthing.timer
sudo systemctl enable syncthing.timer
sudo systemctl status syncthing.timer
sudo systemctl daemon-reload

# 管理
sudo systemctl status pkgctl-syncthing.service
sudo systemctl restart pkgctl-syncthing.service
```

### 手动安装 syncthing

下载地址：<https://syncthing.net/downloads/> 群晖上选择 ARM (64‑bit)  即可。

```sh
# 下载后将主程序 syncthing 放至 ~/.local/bin/ 目录下
chmod 744 ~/.local/bin/syncthing

# 启动一下，让它自动生成配置文件
syncthing --gui-address="0.0.0.0:8384" --no-browser
# ctrl + C 终止运行

# 修改监听地址：127.0.0.1 --> 0.0.0.0，远程可以访问
#sed -i 's/127\.0\.0\.1/0\.0\.0\.0/' ~/.local/state/syncthing/config.xml

# 创建服务文件
cat << EOF | sudo tee /etc/systemd/system/syncthing@${USER}.service
[Unit]
Description=Syncthing - Open Source Continuous File Synchronization for %i
Documentation=man:syncthing(1)
After=network.target
StartLimitIntervalSec=60
StartLimitBurst=4

[Service]
User=%i
ExecStart=$HOME/.local/bin/syncthing serve --no-browser --no-restart --home=$HOME/.local/state/syncthing
Restart=on-failure
RestartSec=1
SuccessExitStatus=3 4
RestartForceExitStatus=3 4

# Hardening
ProtectSystem=full
PrivateTmp=true
SystemCallArchitectures=native
MemoryDenyWriteExecute=true
NoNewPrivileges=true

# Elevated permissions to sync ownership (disabled by default),
# see https://docs.syncthing.net/advanced/folder-sync-ownership
#AmbientCapabilities=CAP_CHOWN CAP_FOWNER

[Install]
WantedBy=multi-user.target
EOF

# 管理服务
# 设置开机自动启动
sudo systemctl enable syncthing@${USER}.service
# 启动服务
sudo systemctl start syncthing@${USER}.service
# 重启服务
sudo systemctl restart syncthing@${USER}.service
# 查看服务状态
sudo systemctl status syncthing@${USER}.service
# 设置开启不启动
sudo systemctl disable syncthing@${USER}.service
# 停止服务
sudo systemctl stop syncthing@${USER}.service
#  
sudo systemctl daemon-reload
systemctl list-units --type=service
systemctl list-unit-files --type=service
# 查看系统日志
journalctl -e -u syncthing@${USER}.service
systemctl edit syncthing@${USER}.service
# 再次测试
ps -ef | grep -i syncthing
```

控制启动

```sh
sudo systemctl status syncthing@${USER}.service
# 禁用开机启动
sudo systemctl disable syncthing@${USER}.service

# 设置每天下午 16 点启动
cat << EOF | sudo tee /usr/lib/systemd/system/syncthing.timer
[Unit]
Description=Runs syncthing at 16:00 everyday

[Timer]
OnCalendar=16:00:00
Unit=syncthing@${USER}.service

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl enable syncthing.timer
sudo systemctl start syncthing.timer
sudo systemctl status syncthing.timer
sudo systemctl daemon-reload

# 管理
sudo systemctl status syncthing@${USER}.service
sudo systemctl restart syncthing@${USER}.service
```

### 配置 syncthing 证书（未成功）

```sh
# 查看默认的证书目录名称
sudo cat /usr/syno/etc/certificate/_archive/DEFAULT

# 系统证书位置
CERT_DIR=/usr/syno/etc/certificate/_archive/xozyEg
# syncthing 配置目录
CONF_DIR=~/.local/state/syncthing
# 创建证书的软连接
ln -sf ${CERT_DIR}/cert.pem ${CONF_DIR}/https-cert.pem
ln -sf ${CERT_DIR}/privkey.pem ${CONF_DIR}/https-key.pem

sudo cp -f ${CERT_DIR}/cert.pem ${CONF_DIR}/https-cert.pem
sudo cp -f ${CERT_DIR}/privkey.pem ${CONF_DIR}/https-key.pem

# 查看配置情况
ls -la ${CONF_DIR}
```

## 虚拟机安装群晖 DSM7.2

在 VMware 中创建磁盘，类型选择 SATA，启动，快速按 F2，选择 SATA 硬盘启动，如果没有进入 BOOT 界面，按 `CTRL + ALT + INSERT` 重启。

下载最新版的 rr：<https://github.com/RROrg/rr/releases>

VMware 设置：<https://rrorg.cn/archives/vmconfig>

安装教程：<https://rrorg.cn/archives/Use%20guide>

```sh
# 安装 qemu
sudo apt install qemu-utils
# 将下载的 rr.img 转换为 VMware 虚拟磁盘文件
qemu-img convert -f raw -O vmdk rr.img rr.vmdk
```

配置 VMware，EFI 模式，内存至少 4G，

## 虚拟机安装群晖 DSM（作废）

参考：<https://xpenology.com/forum/>

<https://xpenology.com/forum/topic/13346-tutorial-dsm-62-on-vmware-workstation-player-15/>

<https://openwrt.org/docs/guide-user/virtualization/vmware>

<https://www.codeidc.com/archives/177>

下载最新版的 `synoboot.img`，在 LinuxMint 下进行操作。

```sh
# 搜索包含 qemu 的软件包
apt search qemu
sudo apt install qemu-utils
# 转换为 VMware 虚拟磁盘文件
qemu-img convert -f raw -O vmdk synoboot.img synoboot.vmdk
```

在 VMware 中创建虚拟机，注意以下几点：

>* 选择 自定义（高级）
>* 稍后安装操作系统
>* 客户机操作系统：Linux - Linux4.x 或更高版本内核 64 位
>* 网络连接：使用桥接网络
>* SCSI 控制：LSI Logic（L）（推荐）
>* 虚拟磁盘类型：SCSI，大小选择 20G，作为存储盘

创建完成后，编辑虚拟机设置：

>* 删除光驱、打印机
>* 添加硬盘 - SATA，使用现有虚拟磁盘，将刚才转换的 synoboot.vmdk 复制至 DSM 目录，选择刚才转换的 synoboot.vmdk

开机启动，快速按下 F2，将 SATA 硬盘作为第一引导。

>注意：Hard Drive 选项下有二级菜单，在二级菜单里调整顺序，将 SATA 硬盘作为第一引导。

在虚拟机中按 `Ctrl + Alt + Insert` 重启虚拟机，然后进入 GRUB 界面，选择 最后一项 `VMwar/ESXI`

启动后稍等一会儿，使用 <http://find.synology.com> 自动查找群晖的 ip 地址，或是直接输入群晖的 IP，然后回车即可。

群辉的 hostname 是 `DiskStation`。
