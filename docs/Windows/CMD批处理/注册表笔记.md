# 注册表笔记

## 笔记

* 注册表文件应以 `Windows Registry Editor Version 5.00` 开头。
* 注册表中如果包含中文字符，建议采用 `UTF-16 LE 带签名` 编码格式存储，也可以使用 `GBK` 编码。

## 语法

常用的键值简称：

>HKCR = HKEY_CLASSES_ROOT
>HKCU = HKEY_CURRENT_USER
>HKLM = HKEY_LOCAL_MACHINE
>HKU  = HKEY_USERS
>HKCC = HKEY_CURRENT_CONFIG

特殊字符 `\`、`"` 需要使用 `\` 转义。

## 在资源管理器中添加右键

方案一，直接添加右键命令：

```ini
Windows Registry Editor Version 5.00

[HKEY_CLASSES_ROOT\DesktopBackground\shell\switch_dark_mode]
@="DarkMode/LightMode"
"Icon"="imageres.dll,-1401"

[HKEY_CLASSES_ROOT\DesktopBackground\shell\switch_dark_mode\command]
@="wscript.exe \"D:\\App\\Shell\\switch_dark_mode\\run.vbs\""
```

方案二，创建二级右键菜单：

```ini
Windows Registry Editor Version 5.00
;右键 系统管理
[HKEY_CLASSES_ROOT\DesktopBackground\shell\tools]
"MUIVerb"="系统管理"
"SubCommands"=""
"Icon"="imageres.dll,-27"
;-------------------------------------------------------------------
;桌面右键添加控制面板
[HKEY_CLASSES_ROOT\DesktopBackground\shell\tools\shell\controlpanel]
@="控制面板"
"Icon"="imageres.dll,-27"
[HKEY_CLASSES_ROOT\DesktopBackground\shell\tools\shell\controlpanel\command]
@="rundll32.exe shell32.dll,Control_RunDLL"

;注册表
[HKEY_CLASSES_ROOT\DesktopBackground\shell\tools\shell\regedit]
@="注册表"
"Icon"="%SystemRoot%\\regedit.exe,0"
[HKEY_CLASSES_ROOT\DesktopBackground\shell\tools\shell\regedit\command]
@="regedit"
```

## 删除注册表中的项

```ini
[-HKEY_CLASSES_ROOT\SystemFileAssociations\Directory.Image\shell\Play]
```

## 批处理操作注册表

有时候操作注册表需要使用变量，直接采用导入注册表的方案就不行了，需要使用批处理文件来操作注册表。

```sh
@echo off
echo 必须以管理员身份运行该程序
%1 mshta vbscript:Createobject("Shell.Application").ShellExecute("%~s0","::","","runas",1)(window.close)&&exit
cd /d "%~dp0"

reg add HKCR\DesktopBackground\shell\switch_dark_mode /d "DarkMode/LightMode" /f
reg add HKCR\DesktopBackground\shell\switch_dark_mode /v "Icon" /d "imageres.dll,-1401" /f

set run_vbs_path="%~dp0run.vbs"
echo %run_vbs_path%
pause

reg add HKCR\DesktopBackground\shell\switch_dark_mode\command /d "wscript.exe \"%run_vbs_path%\"" /f

pause
```

## 注册表命令参数

参考：<https://www.jianshu.com/p/b9ef487d7c87>

可以看到，代码中添加注册表键的 command 命令时，是以`%v`代表一个路径参数的，还有其他几种参数可以使用：

>系统默认变量的含义：
>%1    表示程序操作的文件
>%2    表示系统默认的打印机
>%3    表示资料扇区
>%4    表示操作的 Port 端口
>"%v"  表示程序操作的路径
