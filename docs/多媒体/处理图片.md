# 处理图片

## 根据文件名修改 exif 信息

参考：<https://exiftool.org/filename.html>

当照片或视频缺少时间信息，判断文件修改时间可以使用时：

```sh
# 先用文件修改时间重命名文件
# exif 信息 --------->  文件名
exiftool "-FileName<fileModifyDate" -d %Y-%m-%d_%H%M%S%%-c.%%e .

# 再根据文件名修改 exif 信息
# 文件名 --------->  exif 信息
# 照片文件，建议修改 CreateDate 而不是 DatetimeOriginal
# exiftool -overwrite_original_in_place "-CreateDate<filename" *.jpg
exiftool -overwrite_original_in_place "-alldates<filename" *.jpg
# MP4 文件写入的时间是 UTC 时间，因此需要额外添加 -api QuickTimeUTC 参数
exiftool -overwrite_original_in_place "-CreateDate<filename" -api QuickTimeUTC *.mp4
```

其他的命令：

```sh
# 根据 exif 信息重命名文件，重命名格式为：2024-06-23_091024-1.jpg
# exif 信息 --------->  文件名
exiftool "-FileName<CreateDate" -d %Y-%m-%d_%H%M%S%%-c.%%e .

# 根据文件名修改 exif 的拍摄日期信息 2024-06-23_091024.jpg
# 文件名 --------->  exif 信息
exiftool -overwrite_original_in_place "-CreateDate<filename" *.jpg
# exiftool -overwrite_original_in_place "-alldates<filename" *.jpg

# 复制 exif 信息
exiftool -TagsFromFile source.jpg -all:all -overwrite_original new.jpg
```

## 色域空间

Display P3 的 ICC 文件下载地址：<https://www.color.org/chardata/rgb/DisplayP3.xalter>

sRGB 使用 sRGB2014 版。ICC 文件下载地址：<https://www.color.org/srgbprofiles.xalter>

JPEG XL、AVIF 是下一代图片格式的最终选手，

次世代的图片格式由不同的利益团体主导，JPEG XL 背后是国际标准化组织 (ISO) 和 国际电信联盟 (ITU)，AVIF 是 Netflix 和 AOMedia（开放媒体联盟），WebP 2 是谷歌。虽然主导方各异，但新格式的特性目标基本都一致。

参考：[JPEG XL、AVIF、WebP 2 · 次世代图片格式评测](https://sspai.com/post/72746)

## jpeg-xl 图片格式

JPEG XL 是 JPEG(联合影像专家组) 2021 年完成的 JPEG 的又一个继任者（JPEG 2000、JPEG XR）。JPEG XL 是一个令人惊喜的图片格式，一改 JPEG(联合影像专家组) 保守、专利限制严格的印象，不仅开源、免专利还与开源社区有积极联系，吸收了 FLIF 格式最为其无损压缩部分。

在次世代的图片格式中，JPEG XL 是唯一可以无损重编码旧有的 JPEG 图片的格式（由于 JPEG 的特性，重编码不是无损的，如果想把旧有 JPEG 转换为其他格式会有一定损失） ，这种对现实的考量非常值得肯定。

```sh
# 无损压缩 jpeg 照片。
# If the input is JPEG, losslessly transcode JPEG, rather than using reencode pixels.
# 或者使用 -j 1 参数。--lossless_jpeg=1
cjxl.exe input.jpg output.jxl -v --lossless_jpeg=1

# 无损还原为 jpeg 照片
djxl.exe output.jxl output_lossless.jpg

#  转换为 jxl 格式照片，默认品质为 90
cjxl.exe input.jpg output_q90.jxl -v -q 90
```

## AVIF 图片格式

参考：<https://github.com/AOMediaCodec/libavif>

<https://web.dev/compress-images-avif/>

AVIF 格式相对于传统图像格式（如 JPEG 和 PNG）具有以下关键优势：

- **卓越的压缩效率：**AVIF 格式采用先进的 AV1 编解码器，可在不损失图像质量的情况下实现更小的文件大小。在许多情况下，AVIF 文件可以比等效的 JPEG 文件小 50%。
- **高质量图像：**AVIF 格式支持高动态范围 (HDR) 成像、广色域和透明度等高级功能，可提供更丰富和逼真的图像。
- **开源和免费：**AVIF 格式基于开源的 AV1 编解码器，无需支付专利许可费。可以成为开发人员和内容创作者更经济实惠选择。
- **广泛兼容和支持：**AVIF 格式已得到主流网络浏览器、图像编辑工具和内容交付网络 (CDN) 的支持。开发人员和内容创作者可以轻松将 AVIF 格式整合到其工作流程中。

尽管 AVIF 格式相对于传统图像格式具有许多优势，但也存在一些限制，开发者和内容创作者应注意：

- **兼容性限制：**AVIF 格式尚未得到所有浏览器和图像编辑工具的支持，因此开发者和内容创作者可能需要为旧版浏览器或不支持 AVIF 的图像编辑工具提供备用选项。
- **编码复杂性：**AV1 编解码器采用的高级编码技术与传统格式相比，需要更长的编码时间。
- **原生支持有限：**并非所有图像编辑工具都能够原生支持 AVIF 格式，用户可能需要依赖第三方插件或在编辑之前将 AVIF 文件转换为其他格式。

AV1 编码器更新很快，最新版的不一定有编译版，可以下载旧的版本。

Windows 下的编译版下载：<https://ci.appveyor.com/project/louquillio/libavif/build/artifacts>

```sh
avifenc --min 0 --max 63 -a end-usage=q -a cq-level=35 -a tune=ssim --jobs 8 input.jpg output.avif

# 命令解释
#
```

## HEIF 图片格式

参考：<https://github.com/strukturag/libheif>

HEIF 格式的图像，苹果的后缀名是 `.heic` ，Windows 下预览、查看 heif 格式的图像，需要下载：[CopyTransHEICforWindows](https://www.copytrans.net/copytransheic) ，但是使用该软件查看、转换成 jpg 文件，色彩配置信息不正确，颜色会有偏差，因此推荐使用 lightroom 转换成 jpg。

Windows 编译版下载：<https://github.com/pphh77/libheif-Windowsbinary>

```sh
# 转换为 heif 格式
heif-enc -q 50 -v -o heif.heic input.jpg
# 通过输出信息可以知道 q50 相当于 CRF25。q60 相当于 CRF20。
exiftool -overwrite_original_in_place -tagsFromFile input.jpg heif.heic
# 复制 exif 信息。

# heif 转换为 jpg 格式
heif-convert -q 95 heif.heic output.jpg
```

## webp 图片格式

<https://developers.google.cn/speed/webp/download>

webp 命令行转换工具下载地址：（上面的 `WebpCodecSetup.exe` 其实就是  WebP Codec for Windows）

<https://storage.googleapis.com/downloads.webmproject.org/releases/webp/index.html>

WebP Codec for Windows 下载地址：

<https://codecpack.co/download/WebP-Codec-for-Windows.html>

<https://github.com/webmproject/webp-wic-codec/>

```bash
# 有损压缩为 webp 格式。
cwebp -q 85 20190501_010.tif -o 85.webp
# -q float 指定压缩因素，范围是0-100，默认为75。85相当于lightroom里jpg的85品质，但体积比jpg的一半还小。

#-------------------------------
# webp 格式转换为 jpg 格式。


#-------------------------------


# 无损压缩
cwebp -lossless -z 6 20190501_010.tif -o lossless.webp
# -z 6 在0-9之间切换无损耗压缩模式，0级最快，9级最慢。快速模式产生的文件大小比较慢的文件要大。默认是6。如果-q或者-m之后被使用，-z将无效。
# 无损压缩后的体积是 tif 文件的1/5左右。
```
