# 处理视频

## FFmpeg 压制视频

如果要一键批量压制，FFmpeg 是更好的选择，缺点：由于 GPL 原因，无法内置 FDK AAC、NeroAAC 编码器。

官方 FFmpeg 下载地址：<https://ffmpeg.org/download.html>

x265 下载地址：<http://msystem.waw.pl/x265/>

Mediainfo 下载地址：<https://mediaarea.net/en/MediaInfo/Download/Windows>

参考：[为 iOS 制作 HEVC 视频](<https://hyjk2000.github.io/2017/10/20/encoding-ios-playable-hevc-video.html>)

包含 `nonfree` 包的下载地址：

<https://github.com/AnimMouse/ffmpeg-autobuild>

<https://github.com/marierose147/ffmpeg_windows_exe_with_fdk_aac>

```sh
# 完整版的帮助
ffmpeg -h full
# 查看 libx264 库的帮助
ffmpeg -h encoder=libx265
```

## X265 编码

参考：<https://trac.ffmpeg.org/wiki/Encode/H.265>

<https://codecalamity.com/encoding-settings-for-hdr-4k-videos-using-10-bit-x265/>

压制参数：

```sh
ffmpeg -i input.mov -c:v libx265 -crf 26 -preset slow -c:a copy output_x265.mkv
# 默认的编码质量为 28（质量上约等于 x264 的 CRF 23，体积为 x264 的一半），值越小，质量越高。
# CRF 26 转换后，体积是 iphon13 拍摄 4K 视频的一半。
# 转换为 mkv 格式才能保留 杜比 HDR 信息。
# -preset slow 参考网络，使用 slow 的预设，压制质量明显提高，体积也会稍微增大。
```

As with x264, you need to make several choices:

- Choose a CRF. CRF affects the quality. The default is 28, and it should visually correspond to libx264 video at CRF 23, but result in about half the file size. CRF works just like in x264, so choose the highest value that provides an acceptable quality.
- Choose a preset. The default is `medium`. The preset determines compression efficiency and therefore affects encoding speed. Valid presets are `ultrafast`, `superfast`, `veryfast`, `faster`, `fast`, `medium`, `slow`, `slower`, `veryslow`, and `placebo`. Use the slowest preset you have patience for. Ignore `placebo` as it provides insignificant returns for a significant increase in encoding time.
- Choose a tune (optional). By default, this is disabled, and it is generally not required to set a tune option. x265 supports the following `-tune` options: `psnr`, `ssim`, `grain`, `zerolatency`, `fastdecode`. They are explained in the [H.264 guide](https://trac.ffmpeg.org/wiki/Encode/H.264#crf).

压缩命令：

```sh
# https://github.com/GPUOpen-LibrariesAndSDKs/AMF/wiki/AMF%20Encoder%20Settings%20and%20Tuning%20in%20FFmpeg

# https://www.chiphell.com/thread-2539978-1-1.html
ffmpeg -i input.mov -c:v hevc_amf -rc cqp -qp_i 30 -qp_p 30 -quality quality -c:a copy output_x265_8bit.mkv
```

## AV1 编码

参考：<https://trac.ffmpeg.org/wiki/Encode/AV1>

<https://blog.nannan.cool/archives/105/>

av1 编码器更新迅速，因此需要下载最新的 git master builds。

```sh
ffmpeg -i input.mov -c:v libsvtav1 -preset 8 -crf 35 -g 300 -svtav1-params scd=1 -c:a copy output_av1.mkv
# AV1 的 CRF 35 相当于 x265 的 CRF 26。

# -preset 8（默认值是 10）。参考 nannan 的博客，设置为 4 比较合理，但是我的电脑只能设置到 8，值再小的话，就会提示内存不足。

# -g <int>        E..V....... set the group of picture (GOP) size (from INT_MIN to INT_MAX) (default 12)
# By default, SVT-AV1's keyframe interval 2-3 seconds, which is quite short for most use cases. Consider changing this up to 10 seconds with the -g option; -g 240 for 24 fps content, -g 300 for 30 fps, etc.

# The valid CRF value range is 0-63, with the default being 50. Lower values correspond to higher quality and greater file size. Lossless encoding is currently not supported.

# Note that as of SVT-AV1 0.9.1, scene change detection is not considered to be in an optimal state and is disabled by default. This means that the default behavior is to place keyframes at set intervals instead of at scene changes and other optimal locations. Scene change detection can be turned on with -sc_detection 1 or via the svtav1-params option scd=1.
```

## 视频压制常用参数

### 强制 10bit 压制

```sh
# av1 编码使用 10bit
ffmpeg -i input.mp4 -c:v libsvtav1 -preset 8 -crf 35 -g 300 -svtav1-params scd=1 -pix_fmt yuv420p10le -c:a copy output_av1.mkv

ffmpeg -i input.mov -c:v libsvtav1 -preset 8 -crf 35 -g 300 -svtav1-params scd=1 -c:a copy av1_crf35_8bit.mkv

# x265 编码使用 10bit
ffmpeg -i input.mov -c:v libx265 -crf 26 -preset slow -D 10 -c:a copy output_x265.mkv
```

### 修改分辨率

```sh
# 分辨率修改为 1080P
ffmpeg -i input.mov -c:v libx265 -crf 26 -preset slow -vf scale=1920:-2 -c:a copy output_x265_1080P.mkv
```

### 修改帧率

```sh
# 修改帧率为 24fps
ffmpeg -i input.mov -c:v libx265 -crf 26 -preset slow -vf scale=1920:-2,fps=24 -c:a copy output_x265_24fps.mkv
```

## Megui 视频压制

使用 Megui 进行视频压制步骤：

- AVS Script Creator
- 压制

视频：推荐使用 x265 编码进行压制，添加 `-D 10` 参数 10bit 压制，默认质量 26 即可（x265 默认值是 28，x264 默认的质量为 23），得到码率约为 2.3M/s（帧率为24FPS，分辨率为1080P）。

10bit 压制质量更好，体积反而更小（约小 2% 吧），x265 现在的速度约是 x264 的 60%

音频：推荐使用 NeroAAC 编码压制，默认质量 q=5.0 即可（对应单声道码率约为 87kbps，双声道约 175kbps，7.1 声道约 640kbps）。（注：q=5.5 双声道约 200kbps）

封装格式：推荐使用 MKV，Megui 的 mp4 封装格式有问题，无法拖动快进。
